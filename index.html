<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>QR ‚Üí Th√¥ng Tin Thi·∫øt B·ªã</title>

  <script src="https://unpkg.com/html5-qrcode"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    body { font-family: Arial; padding: 15px; }
    #reader { width: 300px; margin: auto; }
    #info-box {
      margin-top: 20px;
      padding: 12px;
      border: 1px solid #ccc;
      border-radius: 10px;
      background: #f7f7f7;
      font-size: 14px;
    }
    .row { margin-bottom: 6px; }
    .label { font-weight: bold; color: #004; width: 160px; display: inline-block; }
  </style>
</head>
<body>

  <h2>Qu√©t QR l·∫•y th√¥ng tin thi·∫øt b·ªã</h2>

  <div id="reader"></div>

  <h3>ID qu√©t ƒë∆∞·ª£c:</h3>
  <div id="result">Ch∆∞a qu√©t</div>

  <h3>Th√¥ng tin thi·∫øt b·ªã:</h3>
  <div id="info-box">Kh√¥ng c√≥ d·ªØ li·ªáu</div>

<script>

  // üëâ THAY LINK CSV C·ª¶A M V√ÄO ƒê√ÇY
  const CSV_URL = "https://ttigroup-my.sharepoint.com/:x:/g/personal/nhattruong_ha_ttigroup_com_vn/IQCydKnEOE9BRZwb_A6M19n1AXP5nPuo8wJfNFrLBAcZPo8?e=TX4IaO";

  // Danh s√°ch c·ªôt theo ƒë√∫ng th·ª© t·ª±
  const COLUMNS = [
    "Code","No","Category","Brand","Model_NO","Serial_No","Asset_Type",
    "LAB_Description","FA_Description","Specification","Control_NO","Assets_NO",
    "Responsible_By","Team","Location","Picture","Function","Week Control",
    "Purchase_Date","Supplier","Received_By","PO_No",
    "Calibration_Date","Due_Date","PM_Date","Next_PM",
    "Status","Remark"
  ];

  // Format ng√†y dd/MM/yyyy
  function formatDate(value) {
    if (!value) return "";
    let d = new Date(value);
    if (d.toString() === "Invalid Date") return value; // gi·ªØ nguy√™n n·∫øu kh√¥ng ph·∫£i ng√†y
    return d.getDate().toString().padStart(2, "0") + "/" +
           (d.getMonth() + 1).toString().padStart(2, "0") + "/" +
           d.getFullYear();
  }

  // Load CSV b·∫±ng PapaParse
  function loadCSV() {
    return new Promise(resolve => {
      Papa.parse(CSV_URL, {
        download: true,
        header: true,
        complete: result => resolve(result.data)
      });
    });
  }

  async function startScanner() {
    const cameras = await Html5Qrcode.getCameras();

    let backCam = cameras.find(cam =>
      cam.label.toLowerCase().includes("back") ||
      cam.label.toLowerCase().includes("rear") ||
      cam.label.toLowerCase().includes("environment")
    );

    const cameraId = backCam ? backCam.id : cameras[cameras.length - 1].id;

    const scanner = new Html5Qrcode("reader");
    scanner.start(
      cameraId,
      { fps: 10, qrbox: 250 },
      async (decodedText) => {
        document.getElementById("result").innerHTML = decodedText;

        const rows = await loadCSV();

        // t√¨m theo Code (ID QR)
        let item = rows.find(r => r.Code === decodedText);

        if (!item) {
          document.getElementById("info-box").innerHTML = "<b>Kh√¥ng t√¨m th·∫•y thi·∫øt b·ªã!</b>";
          return;
        }

        // T·∫°o HTML hi·ªÉn th·ªã theo ƒë√∫ng th·ª© t·ª± c·ªôt
        let html = "";
        COLUMNS.forEach(col => {
          let value = item[col] ?? "";

          // format ng√†y n·∫øu l√† c·ªôt ng√†y
          if (["Purchase_Date","Calibration_Date","Due_Date","PM_Date","Next_PM"].includes(col)) {
            value = formatDate(value);
          }

          html += `<div class='row'><span class='label'>${col}:</span> ${value}</div>`;
        });

        document.getElementById("info-box").innerHTML = html;
      }
    );
  }

  startScanner();

</script>

</body>
</html>
